\section{Program Logic for Location Virtualization}
\label{sec:logic}
In this section, we describe our high-level reasoning principles for location virtualization whose detailed justification is shown in \sref{sec:soundness}. The principles shown here are mainly shaped around understanding and expressing the fact related the virtual address space, most specifically virtualization and translation of memory locations .
\subsection{Points-To Assertions}
\label{sec:pointsto}

We present three main points-to relations as part of utilization of separation logic \ref{} as an ambient logic:
\begin{enumerate}
\item Physical address points-to, $\pfpointsto\locsf\locsf\qfrac\ppts$
\item Register points-to, $\pfpointsto\rg\rv\qfrac\rpts$
\item Virtual memory address points-to, $\pfpointsto\vaddr\locsf\qfrac\vpts$
\end{enumerate}
\paragraph{Register points-to} The assertion $\pfpointsto\rg\rv\rpts\qfrac$ ensures the ownership of the register $\rg$ naming the register value $\rv$. The fraction $\qfrac$ with value 1 asserts the unique ownership of the register mapping, and grants update permission on it, otherwise, any value $0 < \qfrac <1$ represents partial ownership granting readonly permission on the mapping.
\paragraph{Physical-Memory points-to} The our physical memory points-to relation ($\pfpointsto\locsf\locsf\qfrac\ppts$) exhibits nested-mappings due to masking applied on the indexing address ($\locsf$). The unfolded definition of the physical mapsto 
\begin{figure}[!ht]
\[
\begin{array}{cl}
\pfpointsto\locsf\locsf\qfrac\ppts \stackrel{def}{=} & \nfpointsto{\mask\locsf\tw}{\mask\locsf\ft}\locsf\qfrac\naddr
\end{array}
\]
\caption{Physical Points-to with Nested Masking}
  \label{fig:physicalpointsto}
\end{figure}
where we simply abstract the generation of hierarchical mapping of a physical address ($\locsf$) through the different masks of the address ($\locsf|^{12}$ and $\locsf|^{52}$) as nested map resources.
\paragraph{Virtual-Memory points-to} As we see in Figure \fref{fig:}, virtual address mapping is obtained via traversal of page table, i.e. indirection provided by physical memory lookups. As expected, we define the virtual-points to relation, ($\pfpointsto\vaddr\locsf\qfrac\vpts$), in terms of multiple physical memory mappings representing the indirection shown in Figure \fref{fig:}
\begin{figure*}
\[
\begin{array}{l}
  \ppointsto\vaddr\locsf\vpts \stackrel{def}{=} \lambda \tlf\Loc.\\
  \exists_{\tlfoff\Locn \;, \tltoff\Locn \;, \tltwoff\Locn \;,\tlooff\Locn \;, \tpgoff\Loctw \;, \tlt\Loc \;, \tltw\Loc \;, \tlo\Loc \tpg\Loc} \ldotp \\
  \ulcorner \textsf{aligned } \vaddr \urcorner \star 
   \ulcorner \vaddr = \locsx :: \lfoff :: \ltoff :: 
   \ltwoff :: \looff :: \pgoff \urcorner \star\\
  \pfpointsto{\lvlsum\crt\lfoff}{\lvlbor\lt}\qfracfotsss\ppts \star 
  \pfpointsto{\lvlsum\lt\ltoff}{\lvlbor\ltw}\qfracfotss\ppts \star \\
  \pfpointsto{\lvlsum\ltw\ltwoff}{\lvlbor\lo}\qfracfots\ppts \star 
  \pfpointsto{\lvlsum\lo\looff}{\lvlbor\pg}\qfracfot\ppts \star \\
  \ppointsto{\pageptstosum\pg\pgoff}\locsf\ppts 
\end{array}
\]
\caption{Virtual Points-to Relation}
\todo[inline]{These fractions aren't quite right (though I see you added the variance between levels), I can walk you through in our meeting tomorrow.}
  \label{fig:virtualpointsto}
\end{figure*}
\todo{iso todo: stress fractions and aligment}
\subsection{Reasoning Rules for Selected Instructions}
\label{sec:reasoning}
\input{fig-reasoning}
As is usual in \SL, the reasoning rules of the program logic allow deriving
Hoare triples of the form $\triple\pre\instr\post$, where the
precondition~$\pre$ and the postcondition~$\post$ are assertions,
and where $i$ is an instruction.
Such a triple receives a standard interpretation as a statement of partial
correctness: the assertion $\triple\pre\instr\post$ means that, in a state
where $\pre$ holds, it is safe to execute the instruction~$\instr$, and if
this execution terminates, then it leads to a final state where $\post$ holds.
A more precise statement is given in the next section (\sref{sec:soundness}).
\mytodo{iso todo: talk about each rule and change the intro to this subsection}
\subsection{Modal Abstraction for Virtualizing Memory Locations}
\label{sec:modallocationvirtualization}
\input{fig-laws}
The most essential part of our reasoning principles is shaped around abstractions for location virtualization, more concretely virtual memory points-to relation in Figure \fref{fig:virtualpointsto}. One might have already noticed that the resource represented by the virtual-points to is not only a simple immediately mapped singly resource but also
\begin{itemize}
\item a tree-like structured resrouce rooted at the certain physical memory address ($\crt$) -- not a single resource mapping abstraction 
\item the shared indirection levels abstracted as mappings with fractional permissions
\item through partially owned set of resource mappings grants the eventual uniquely ownable single resource, i.e. page address 
\end{itemize}
which we think can be well-summarized with the modal abstraction shown in \RULE{ModalLocVirt} which allows us to have
\begin{itemize}
  \item \textbf{contingency}: the fact $\modalP$ abstracts the memory address mappings \textit{under} the address space rooted at $\ell$ (e.g. $\crt$)
  \item \textbf{hiding states}: \textit{controlled-independence} from the indirection abstracted as page-table mappings is achieved through hiding them under the virtual address space modality
  \item \textbf{interaction with ambient logic for a local-state}: \mytodo{talk about this issue's vitality in this paper with Colin}
\end{itemize}

To concretize the understanding of these principles achieved with the modal abstraction for address-space, $\modaldef\ell\modalP$, let us first investigate the specification of the instruction ($\textsf{movctl\_instr}$) switching address spaces. Assume that our CPU keeps the current address space based on its page table register CR3, as we see in Figure \fref{fig:addressspaceswitching}.
\input{fig-ctlreasoning}
Thinking of $\modalP$ and $\modalQ$ as resources representing the indirection mappings ($\mapsto_{\kw{p}}$) in the address spaces rooted at $\rvsrc$ and $\rvdst$ respectively, the rule interacts with the ambient logic, \SL, via pulls local state out of the address-space modality rooted at $\rvdst$, and make it the observable view of the memory.

\todo[inline]{We don't need to talk about sexec at all. Let's also talk tomorrow about adjusting the syntax in the paper to mimic actual textual assembly more closely (e.g., all of the instructions are mov, with different argument shapes)}

\mytodo{STOP HERE}
